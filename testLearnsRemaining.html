<!DOCTYPE html>
<html>
<head>
    <title>Test Learns Remaining</title>
</head>
<body>
    <h1>Test Learns Remaining Function</h1>
    
    <button onclick="testLearnsRemaining()">Test Learns Remaining</button>
    
    <textarea id="output" rows="10" cols="60"></textarea>
    
    <script src="dataManager.js"></script>
    <script src="start.js"></script>
    <script>
        async function testLearnsRemaining() {
            const overallStart = performance.now();
            let breakdown = [];
            
            try {
                // Test loadUserData breakdown
                let start = performance.now();
                const content = localStorage.getItem('userData');
                let end = performance.now();
                breakdown.push(`1. Get from localStorage: ${(end - start).toFixed(3)}ms`);
                
                start = performance.now();
                const lines = content.split(/\r\n|\r|\n/);
                end = performance.now();
                breakdown.push(`2. Split lines (${lines.length} lines): ${(end - start).toFixed(3)}ms`);
                
                start = performance.now();
                const headerRowIndex = dataManager.findHeaderRowIndex(lines);
                end = performance.now();
                breakdown.push(`3. Find header row: ${(end - start).toFixed(3)}ms`);
                
                start = performance.now();
                const userData = [];
                for (let i = 0; i < lines.length; i++) {
                    const line = lines[i].trim();
                    if (line && !line.startsWith('#') && i !== headerRowIndex) {
                        const columns = line.split('\t');
                        if (columns.length >= 3) {
                            userData.push({
                                id: columns[0].trim(),
                                nrd: columns[1].trim(),
                                level: parseInt(columns[2].trim())
                            });
                        }
                    }
                }
                end = performance.now();
                breakdown.push(`4. Parse ${userData.length} data rows: ${(end - start).toFixed(3)}ms`);
                
                start = performance.now();
                const counts = { new: 0, familiar: 0, known: 0 };
                userData.forEach(user => {
                    if (user.level < 5) {
                        counts.new += 1;
                    } else if (user.level >= 5 && user.level < 10) {
                        counts.familiar += 1;
                    } else if (user.level >= 10) {
                        counts.known += 1;
                    }
                });
                end = performance.now();
                breakdown.push(`5. Count levels: ${(end - start).toFixed(3)}ms`);
                
                start = performance.now();
                const settings = await dataManager.loadSettings();
                const licenceParts = settings.licence.split('-');
                const tier = licenceParts[3];
                const tierMap = {'T1': 750, 'N2': 1500, 'M3': 2250, 'R4': 3000};
                const totalForTier = tierMap[tier];
                const alreadyLearned = counts.new + counts.familiar + counts.known;
                const result = totalForTier - alreadyLearned;
                end = performance.now();
                breakdown.push(`6. Calculate final result: ${(end - start).toFixed(3)}ms`);
                
                const overallEnd = performance.now();
                const totalTime = (overallEnd - overallStart).toFixed(3);
                
                document.getElementById('output').value = 
                    `PERFORMANCE BREAKDOWN:\n` +
                    breakdown.join('\n') + 
                    `\n\nTOTAL TIME: ${totalTime}ms\n` +
                    `RESULT: ${result} learns remaining\n` +
                    `COUNTS: New: ${counts.new}, Familiar: ${counts.familiar}, Known: ${counts.known}`;
                    
            } catch (error) {
                const overallEnd = performance.now();
                const totalTime = (overallEnd - overallStart).toFixed(3);
                
                document.getElementById('output').value = `Error: ${error.message}\nTime: ${totalTime}ms`;
            }
        }
        
        // Load data first
        window.addEventListener('load', function() {
            dataManager.loadAllToStorage().then(() => {
                console.log('Data loaded to localStorage');
            });
        });
    </script>
</body>
</html>
