<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TSV to JSON Parser</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }
        .step {
            margin-bottom: 30px;
            padding: 20px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            background-color: #fafafa;
        }
        .step h2 {
            color: #555;
            margin-top: 0;
            margin-bottom: 15px;
        }
        input[type="file"] {
            width: 100%;
            padding: 10px;
            border: 2px dashed #ccc;
            border-radius: 5px;
            background-color: white;
            cursor: pointer;
        }
        input[type="file"]:hover {
            border-color: #007AFF;
        }
        button {
            background-color: #007AFF;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            margin-right: 10px;
            margin-top: 10px;
        }
        button:hover {
            background-color: #0056CC;
        }
        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        .preview {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 15px;
            margin-top: 15px;
            font-family: monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        .info {
            background-color: #e7f3ff;
            border-left: 4px solid #007AFF;
            padding: 10px;
            margin: 15px 0;
        }
        .success {
            background-color: #d4edda;
            border-left: 4px solid #28a745;
            padding: 10px;
            margin: 15px 0;
            color: #155724;
        }
        .error {
            background-color: #f8d7da;
            border-left: 4px solid #dc3545;
            padding: 10px;
            margin: 15px 0;
            color: #721c24;
        }
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin: 15px 0;
        }
        .stat-box {
            background-color: white;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 15px;
            text-align: center;
        }
        .stat-number {
            font-size: 24px;
            font-weight: bold;
            color: #007AFF;
        }
        .stat-label {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>TSV to JSON Parser</h1>
        
        <div class="step">
            <h2>Step 1: Select TSV File</h2>
            <input type="file" id="fileInput" accept=".tsv,.txt" />
            <div class="info">
                Select your TSV file (up to 4600 rows, 14 columns). The parser handles various line endings including \\r, \\n, and \\r\\n.
            </div>
        </div>
        
        <div class="step">
            <h2>Step 2: Parse and Preview</h2>
            <button id="parseBtn" disabled>Parse TSV File</button>
            <div id="parseStatus"></div>
            <div id="dataPreview"></div>
        </div>
        
        <div class="step">
            <h2>Step 3: Save to Local Storage</h2>
            <button id="saveBtn" disabled>Save as "curriculum" to Local Storage</button>
            <button id="downloadBtn" disabled>Download JSON File</button>
            <div id="saveStatus"></div>
        </div>
        
        <div class="step">
            <h2>Step 4: Convert JSON Back to TSV</h2>
            <button id="jsonToTsvBtn" disabled>Convert to TSV and Download</button>
            <div class="info">
                Load data from local storage first, then convert back to TSV format for download.
            </div>
            <div id="conversionStatus"></div>
        </div>
        
        <div class="step">
            <h2>Local Storage Manager</h2>
            <button id="loadBtn">Load "curriculum" from Local Storage</button>
            <button id="clearBtn">Clear "curriculum" from Local Storage</button>
            <div id="storageStatus"></div>
        </div>
    </div>

    <script>
        let parsedData = null;
        let fileContent = '';
        
        const fileInput = document.getElementById('fileInput');
        const parseBtn = document.getElementById('parseBtn');
        const saveBtn = document.getElementById('saveBtn');
        const downloadBtn = document.getElementById('downloadBtn');
        const loadBtn = document.getElementById('loadBtn');
        const clearBtn = document.getElementById('clearBtn');
        const jsonToTsvBtn = document.getElementById('jsonToTsvBtn');
        
        // File input handler
        fileInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    fileContent = e.target.result;
                    parseBtn.disabled = false;
                    document.getElementById('parseStatus').innerHTML = 
                        `<div class="info">File loaded: ${file.name} (${file.size} bytes)</div>`;
                };
                reader.readAsText(file);
            }
        });
        
        // Parse button handler
        parseBtn.addEventListener('click', function() {
            try {
                parsedData = parseTSV(fileContent);
                displayPreview(parsedData);
                saveBtn.disabled = false;
                downloadBtn.disabled = false;
                jsonToTsvBtn.disabled = false;
                
                document.getElementById('parseStatus').innerHTML = 
                    `<div class="success">Successfully parsed TSV file!</div>`;
            } catch (error) {
                document.getElementById('parseStatus').innerHTML = 
                    `<div class="error">Error parsing file: ${error.message}</div>`;
                console.error('Parse error:', error);
            }
        });
        
        // Save to localStorage button handler
        saveBtn.addEventListener('click', function() {
            try {
                const jsonString = JSON.stringify(parsedData, null, 2);
                localStorage.setItem('curriculum', jsonString);
                document.getElementById('saveStatus').innerHTML = 
                    `<div class="success">Data saved to local storage as "curriculum"!</div>`;
            } catch (error) {
                document.getElementById('saveStatus').innerHTML = 
                    `<div class="error">Error saving to local storage: ${error.message}</div>`;
            }
        });
        
        // Download JSON button handler
        downloadBtn.addEventListener('click', function() {
            try {
                const jsonString = JSON.stringify(parsedData, null, 2);
                const blob = new Blob([jsonString], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'curriculum.json';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            } catch (error) {
                document.getElementById('saveStatus').innerHTML = 
                    `<div class="error">Error downloading file: ${error.message}</div>`;
            }
        });
        
        // Load from localStorage button handler
        loadBtn.addEventListener('click', function() {
            try {
                const stored = localStorage.getItem('curriculum');
                if (stored) {
                    parsedData = JSON.parse(stored);
                    displayPreview(parsedData);
                    saveBtn.disabled = false;
                    downloadBtn.disabled = false;
                    jsonToTsvBtn.disabled = false;
                    document.getElementById('storageStatus').innerHTML = 
                        `<div class="success">Loaded "curriculum" from local storage!</div>`;
                } else {
                    document.getElementById('storageStatus').innerHTML = 
                        `<div class="info">No "curriculum" data found in local storage.</div>`;
                }
            } catch (error) {
                document.getElementById('storageStatus').innerHTML = 
                    `<div class="error">Error loading from local storage: ${error.message}</div>`;
            }
        });
        
        // Clear localStorage button handler
        clearBtn.addEventListener('click', function() {
            try {
                localStorage.removeItem('curriculum');
                document.getElementById('storageStatus').innerHTML = 
                    `<div class="success">"curriculum" data cleared from local storage.</div>`;
            } catch (error) {
                document.getElementById('storageStatus').innerHTML = 
                    `<div class="error">Error clearing local storage: ${error.message}</div>`;
            }
        });
        
        // JSON to TSV conversion button handler
        jsonToTsvBtn.addEventListener('click', function() {
            try {
                if (!parsedData) {
                    document.getElementById('conversionStatus').innerHTML = 
                        `<div class="error">No data loaded. Please load data from local storage first.</div>`;
                    return;
                }
                
                const tsvContent = convertToTSV(parsedData);
                downloadTSV(tsvContent);
                
                document.getElementById('conversionStatus').innerHTML = 
                    `<div class="success">TSV file generated and downloaded successfully!</div>`;
            } catch (error) {
                document.getElementById('conversionStatus').innerHTML = 
                    `<div class="error">Error converting to TSV: ${error.message}</div>`;
            }
        });
        
        // Convert JSON data back to TSV format
        function convertToTSV(parsedData) {
            if (!parsedData || !parsedData.headers || !parsedData.data) {
                throw new Error('Invalid data structure for TSV conversion');
            }
            
            let tsvContent = '';
            
            // Add header row
            tsvContent += parsedData.headers.join('\t') + '\n';
            
            // Add data rows
            for (let i = 0; i < parsedData.data.length; i++) {
                const row = parsedData.data[i];
                const rowValues = [];
                
                // Get values in the same order as headers
                for (let j = 0; j < parsedData.headers.length; j++) {
                    const header = parsedData.headers[j];
                    let value = row[header] || '';
                    
                    // Escape any tabs, newlines, or carriage returns in the data
                    value = String(value)
                        .replace(/\t/g, ' ')    // Replace tabs with spaces
                        .replace(/\r/g, ' ')    // Replace carriage returns with spaces
                        .replace(/\n/g, ' ');   // Replace newlines with spaces
                    
                    rowValues.push(value);
                }
                
                // Add any extra columns that were in the original data
                const extraColumns = Object.keys(row).filter(key => 
                    !parsedData.headers.includes(key) && key.startsWith('extra_column_')
                );
                
                for (const extraCol of extraColumns) {
                    let value = row[extraCol] || '';
                    value = String(value)
                        .replace(/\t/g, ' ')
                        .replace(/\r/g, ' ')
                        .replace(/\n/g, ' ');
                    rowValues.push(value);
                }
                
                tsvContent += rowValues.join('\t') + '\n';
            }
            
            return tsvContent;
        }
        
        // Download TSV content as a file
        function downloadTSV(tsvContent) {
            const blob = new Blob([tsvContent], { type: 'text/tab-separated-values' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'curriculum.tsv';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
        
        // TSV parsing function with comprehensive line ending support
        function parseTSV(content) {
            // Normalize all possible line endings to \n
            // Handle \r\n, \r, and \n
            let normalizedContent = content.replace(/\r\n/g, '\n').replace(/\r/g, '\n');
            
            // Split into lines
            const lines = normalizedContent.split('\n').filter(line => line.trim().length > 0);
            
            if (lines.length === 0) {
                throw new Error('File appears to be empty or contains no valid data');
            }
            
            // Parse header row (first line)
            const headers = lines[0].split('\t').map(header => header.trim());
            
            if (headers.length === 0) {
                throw new Error('No headers found in the first row');
            }
            
            // Parse data rows
            const data = [];
            const errors = [];
            
            for (let i = 1; i < lines.length; i++) {
                const line = lines[i];
                if (line.trim() === '') continue; // Skip empty lines
                
                const values = line.split('\t');
                
                // Create object for this row
                const rowObject = {};
                
                // Map values to headers
                for (let j = 0; j < headers.length; j++) {
                    const value = j < values.length ? values[j].trim() : '';
                    rowObject[headers[j]] = value;
                }
                
                // Add any extra columns that don't have headers
                if (values.length > headers.length) {
                    for (let j = headers.length; j < values.length; j++) {
                        rowObject[`extra_column_${j - headers.length + 1}`] = values[j].trim();
                    }
                }
                
                data.push(rowObject);
            }
            
            // Return structured data
            return {
                headers: headers,
                data: data,
                totalRows: data.length,
                totalColumns: headers.length,
                parseDate: new Date().toISOString(),
                errors: errors
            };
        }
        
        // Display preview function
        function displayPreview(parsedData) {
            const previewDiv = document.getElementById('dataPreview');
            
            // Create stats
            const statsHTML = `
                <div class="stats">
                    <div class="stat-box">
                        <div class="stat-number">${parsedData.totalRows}</div>
                        <div class="stat-label">Data Rows</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-number">${parsedData.totalColumns}</div>
                        <div class="stat-label">Columns</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-number">${parsedData.totalRows + 1}</div>
                        <div class="stat-label">Total Rows (incl. header)</div>
                    </div>
                </div>
            `;
            
            // Create preview of first few rows
            const sampleSize = Math.min(3, parsedData.data.length);
            let previewText = "Headers:\n" + parsedData.headers.join(', ') + "\n\n";
            previewText += "Sample data (first " + sampleSize + " rows):\n";
            
            for (let i = 0; i < sampleSize; i++) {
                previewText += `Row ${i + 1}: ${JSON.stringify(parsedData.data[i], null, 2)}\n\n`;
            }
            
            if (parsedData.data.length > sampleSize) {
                previewText += `... and ${parsedData.data.length - sampleSize} more rows`;
            }
            
            previewDiv.innerHTML = statsHTML + '<div class="preview">' + previewText + '</div>';
        }
        
        // Check if curriculum data exists on page load
        window.addEventListener('load', function() {
            const stored = localStorage.getItem('curriculum');
            if (stored) {
                document.getElementById('storageStatus').innerHTML = 
                    `<div class="info">Found existing "curriculum" data in local storage. Click "Load" to view it.</div>`;
            }
        });
    </script>
</body>
</html>