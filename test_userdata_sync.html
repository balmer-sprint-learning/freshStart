<!DOCTYPE html>
<html>
<head>
    <title>UserData IndexedDB Sync Test</title>
</head>
<body>
    <h1>Testing UserData IndexedDB Sync Performance</h1>
    <div id="results"></div>
    
    <script src="dataManager.js"></script>
    <script>
        async function testUserDataSync() {
            const results = document.getElementById('results');
            results.innerHTML = 'Loading userData and testing IndexedDB sync...';
            
            try {
                // Load userData using existing dataManager
                const dataManager = new DataManager();
                await dataManager.loadAllToStorage();
                
                const loadStartTime = performance.now();
                const userData = await dataManager.loadUserData();
                const loadEndTime = performance.now();
                const loadTime = loadEndTime - loadStartTime;
                
                // Test IndexedDB write performance
                const dbName = 'FreshStartDB';
                const dbVersion = 1;
                
                // Open IndexedDB
                const dbOpenStartTime = performance.now();
                const db = await new Promise((resolve, reject) => {
                    const request = indexedDB.open(dbName, dbVersion);
                    request.onerror = () => reject(request.error);
                    request.onsuccess = () => resolve(request.result);
                    request.onupgradeneeded = (event) => {
                        const db = event.target.result;
                        if (!db.objectStoreNames.contains('userData')) {
                            db.createObjectStore('userData', { keyPath: 'id' });
                        }
                        if (!db.objectStoreNames.contains('improves')) {
                            db.createObjectStore('improves', { keyPath: 'id' });
                        }
                    };
                });
                const dbOpenEndTime = performance.now();
                const dbOpenTime = dbOpenEndTime - dbOpenStartTime;
                
                // Write userData to IndexedDB
                const writeStartTime = performance.now();
                const transaction = db.transaction(['userData'], 'readwrite');
                const store = transaction.objectStore('userData');
                
                // Clear existing data
                await new Promise((resolve, reject) => {
                    const clearRequest = store.clear();
                    clearRequest.onsuccess = () => resolve();
                    clearRequest.onerror = () => reject(clearRequest.error);
                });
                
                // Add all userData entries
                for (const item of userData) {
                    await new Promise((resolve, reject) => {
                        const addRequest = store.add(item);
                        addRequest.onsuccess = () => resolve();
                        addRequest.onerror = () => reject(addRequest.error);
                    });
                }
                
                await new Promise((resolve, reject) => {
                    transaction.oncomplete = () => resolve();
                    transaction.onerror = () => reject(transaction.error);
                });
                
                const writeEndTime = performance.now();
                const writeTime = writeEndTime - writeStartTime;
                
                // Test read performance
                const readStartTime = performance.now();
                const readTransaction = db.transaction(['userData'], 'readonly');
                const readStore = readTransaction.objectStore('userData');
                const readData = await new Promise((resolve, reject) => {
                    const getAllRequest = readStore.getAll();
                    getAllRequest.onsuccess = () => resolve(getAllRequest.result);
                    getAllRequest.onerror = () => reject(getAllRequest.error);
                });
                const readEndTime = performance.now();
                const readTime = readEndTime - readStartTime;
                
                db.close();
                
                // Calculate data size
                const dataSize = JSON.stringify(userData).length;
                
                // Display results
                results.innerHTML = `
                    <h2>UserData Sync Performance Results:</h2>
                    <ul>
                        <li><strong>UserData entries:</strong> ${userData.length}</li>
                        <li><strong>Data size:</strong> ${(dataSize / 1024).toFixed(2)} KB</li>
                        <li><strong>Load from dataManager:</strong> ${loadTime.toFixed(2)}ms</li>
                        <li><strong>IndexedDB database open:</strong> ${dbOpenTime.toFixed(2)}ms</li>
                        <li><strong>Write to IndexedDB:</strong> ${writeTime.toFixed(2)}ms</li>
                        <li><strong>Read from IndexedDB:</strong> ${readTime.toFixed(2)}ms</li>
                        <li><strong>Total sync time:</strong> ${(writeTime + dbOpenTime).toFixed(2)}ms</li>
                    </ul>
                    <p><strong>Entries verified:</strong> ${readData.length} (${readData.length === userData.length ? 'MATCH' : 'MISMATCH'})</p>
                    <hr>
                    <h3>Performance Assessment:</h3>
                    <p>${writeTime < 100 ? '✅ Fast enough for per-event syncing' : '⚠️ May be too slow for per-event syncing'}</p>
                `;
                
            } catch (error) {
                results.innerHTML = `<p><strong>Error:</strong> ${error.message}</p>`;
                console.error('Test error:', error);
            }
        }
        
        // Run the test when page loads
        testUserDataSync();
    </script>
</body>
</html>
